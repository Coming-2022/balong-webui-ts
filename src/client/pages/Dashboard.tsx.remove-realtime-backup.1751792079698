import React, { useState, useEffect, useCallback } from 'react';
import { useSocket } from '../hooks/useSocket';
import { parseATIResponse, parseTempResponse, parseSignalResponse, parse5GFreqResponse, parseOperatorResponse } from '../utils/atParser';

interface DeviceInfo {
  manufacturer?: string;
  model?: string;
  revision?: string;
  imei?: string;
  loading: boolean;
  error?: string;
}

interface TemperatureInfo {
  temperature?: number;
  status?: 'normal' | 'warning' | 'critical';
  loading: boolean;
  error?: string;
}

interface SignalInfo {
  rsrp?: number;
  rsrq?: number;
  sinr?: number;
  sysmode?: string;
  loading: boolean;
  error?: string;
}

interface NetworkInfo {
  ccStatus?: '1CC' | '2CC';
  currentCell?: {
    cellId?: string;
    pci?: number;
    earfcn?: number;
    band?: string;
  };
  loading: boolean;
  error?: string;
}

interface ConnectivityInfo {
  pingStatus?: 'success' | 'failed' | 'timeout';
  latency?: number;
  packetLoss?: number;
  deviceConnected?: boolean;
  loading: boolean;
  error?: string;
}

export default function Dashboard() {
  // Socketè¿æ¥
  const { sendCommand, isConnected } = useSocket();
  
  // å„ç±»ä¿¡æ¯çŠ¶æ€
  const [deviceInfo, setDeviceInfo] = useState<DeviceInfo>({ loading: true });
  const [temperatureInfo, setTemperatureInfo] = useState<TemperatureInfo>({ loading: true });
  const [signalInfo, setSignalInfo] = useState<SignalInfo>({ loading: true });
  const [networkInfo, setNetworkInfo] = useState<NetworkInfo>({ loading: true });
  const [connectivityInfo, setConnectivityInfo] = useState<ConnectivityInfo>({ loading: true });
  
  // å…¨å±€çŠ¶æ€
  const [lastUpdate, setLastUpdate] = useState<string>('');
  const [autoRefresh, setAutoRefresh] = useState(false);
  const [refreshInterval, setRefreshInterval] = useState<NodeJS.Timeout | null>(null);
  const [globalLoading, setGlobalLoading] = useState(false);
  const [loadingProgress, setLoadingProgress] = useState({ current: 0, total: 5, message: '' });

  // æ£€æŸ¥è®¾å¤‡è¿æ¥çŠ¶æ€
  const checkDeviceConnection = useCallback(async () => {
    console.log('ğŸ”Œ æ£€æŸ¥è®¾å¤‡è¿æ¥çŠ¶æ€...');
    
    try {
      // æ£€æŸ¥Socketè¿æ¥çŠ¶æ€
      if (!isConnected) {
        console.log('âŒ Socketæœªè¿æ¥');
        return false;
      }
      
      // ä½¿ç”¨sendCommandå‘é€ç®€å•çš„ATå‘½ä»¤æµ‹è¯•è¿æ¥
      console.log('ğŸ”„ ä½¿ç”¨Socketå‘é€ATå‘½ä»¤æµ‹è¯•è¿æ¥...');
      const testResponse = await sendCommand('AT');
      console.log('ğŸ“‹ ATæµ‹è¯•å“åº”:', testResponse);
      
      if (testResponse.success && testResponse.data?.response && testResponse.data.response.includes('OK')) {
        console.log('âœ… ATå‘½ä»¤æµ‹è¯•æˆåŠŸï¼Œè®¾å¤‡å·²è¿æ¥');
        return true;
      }
      
      console.log('âŒ è®¾å¤‡è¿æ¥æµ‹è¯•å¤±è´¥');
      return false;
      
    } catch (error) {
      console.error('âŒ è®¾å¤‡è¿æ¥æ£€æŸ¥å¤±è´¥:', error);
      return false;
    }
  }, [isConnected, sendCommand]);

  // åŠ è½½è®¾å¤‡åŸºæœ¬ä¿¡æ¯ - ä½¿ç”¨useSocket
  const loadDeviceInfo = useCallback(async () => {
    setDeviceInfo(prev => ({ ...prev, loading: true, error: undefined }));
    
    try {
      console.log('ğŸ“± åŠ è½½è®¾å¤‡åŸºæœ¬ä¿¡æ¯...');
      
      // é¦–å…ˆæ£€æŸ¥è®¾å¤‡è¿æ¥
      const isConnected = await checkDeviceConnection();
      if (!isConnected) {
        throw new Error('è®¾å¤‡æœªè¿æ¥ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥çŠ¶æ€');
      }
      
      // ä½¿ç”¨sendCommandè°ƒç”¨ATIå‘½ä»¤è·å–è®¾å¤‡ä¿¡æ¯
      const response = await sendCommand('ATI');
      console.log('ğŸ“‹ ATIå‘½ä»¤å“åº”:', response);
      
      if (response.success && response.data?.response) {
        // ä½¿ç”¨è§£æå·¥å…·å‡½æ•°
        const deviceData = parseATIResponse(response.data.response);
        
        console.log('âœ… è§£æçš„è®¾å¤‡ä¿¡æ¯:', deviceData);
        
        setDeviceInfo({
          manufacturer: deviceData.manufacturer,
          model: deviceData.model,
          revision: deviceData.revision,
          imei: deviceData.imei,
          loading: false
        });
      } else {
        throw new Error(`ATIå‘½ä»¤æ‰§è¡Œå¤±è´¥: ${response.error || 'æœªçŸ¥é”™è¯¯'}`);
      }
    } catch (error: any) {
      console.error('âŒ è®¾å¤‡ä¿¡æ¯åŠ è½½å¤±è´¥:', error);
      
      // ä½¿ç”¨ç¤ºä¾‹æ•°æ®ä½œä¸ºåå¤‡
      setDeviceInfo({
        manufacturer: 'TD Tech Ltd.',
        model: 'MT5700M-CN',
        revision: 'V200R001C20B014',
        imei: '864640060021043',
        loading: false,
        error: `è®¾å¤‡ä¿¡æ¯è·å–å¤±è´¥: ${error.message}`
      });
    }
  }, [checkDeviceConnection, sendCommand]);

  // åŠ è½½æ¸©åº¦ä¿¡æ¯ - ä½¿ç”¨useSocket
  const loadTemperatureInfo = useCallback(async () => {
    setTemperatureInfo(prev => ({ ...prev, loading: true, error: undefined }));
    
    try {
      console.log('ğŸŒ¡ï¸ åŠ è½½æ¸©åº¦ä¿¡æ¯...');
      
      // é¦–å…ˆæ£€æŸ¥è®¾å¤‡è¿æ¥
      const isConnected = await checkDeviceConnection();
      if (!isConnected) {
        throw new Error('è®¾å¤‡æœªè¿æ¥ï¼Œæ— æ³•è·å–æ¸©åº¦ä¿¡æ¯');
      }
      
      // ä½¿ç”¨sendCommandè°ƒç”¨æ¸©åº¦å‘½ä»¤
      const response = await sendCommand('AT^TEMP?');
      console.log('ğŸ“‹ æ¸©åº¦å‘½ä»¤å“åº”:', response);
      
      if (response.success && response.data?.response) {
        // ä½¿ç”¨è§£æå·¥å…·å‡½æ•°
        const temperature = parseTempResponse(response.data.response);
        
        let status: 'normal' | 'warning' | 'critical' = 'normal';
        if (temperature > 70) status = 'critical';
        else if (temperature > 60) status = 'warning';
        
        console.log('âœ… è§£æçš„æ¸©åº¦ä¿¡æ¯:', { temperature, status });
        
        setTemperatureInfo({
          temperature,
          status,
          loading: false
        });
      } else {
        throw new Error(`æ¸©åº¦å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${response.error || 'æœªçŸ¥é”™è¯¯'}`);
      }
    } catch (error: any) {
      console.error('âŒ æ¸©åº¦ä¿¡æ¯åŠ è½½å¤±è´¥:', error);
      setTemperatureInfo({
        temperature: 45,
        status: 'normal',
        loading: false,
        error: `æ¸©åº¦ä¿¡æ¯è·å–å¤±è´¥: ${error.message}`
      });
    }
  }, [checkDeviceConnection, sendCommand]);

  // åŠ è½½ä¿¡å·ä¿¡æ¯ - ä½¿ç”¨useSocket
  const loadSignalInfo = useCallback(async () => {
    setSignalInfo(prev => ({ ...prev, loading: true, error: undefined }));
    
    try {
      console.log('ğŸ“¶ åŠ è½½ä¿¡å·ä¿¡æ¯...');
      
      // é¦–å…ˆæ£€æŸ¥è®¾å¤‡è¿æ¥
      const isConnected = await checkDeviceConnection();
      if (!isConnected) {
        throw new Error('è®¾å¤‡æœªè¿æ¥ï¼Œæ— æ³•è·å–ä¿¡å·ä¿¡æ¯');
      }
      
      // ä½¿ç”¨sendCommandè°ƒç”¨ä¿¡å·å‘½ä»¤
      const response = await sendCommand('AT^HCSQ?');
      console.log('ğŸ“‹ ä¿¡å·å‘½ä»¤å“åº”:', response);
      
      if (response.success && response.data?.response) {
        // ä½¿ç”¨è§£æå·¥å…·å‡½æ•°
        const signalData = parseSignalResponse(response.data.response);
        
        console.log('âœ… è§£æçš„ä¿¡å·ä¿¡æ¯:', signalData);
        
        setSignalInfo({
          ...signalData,
          loading: false
        });
      } else {
        throw new Error(`ä¿¡å·å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${response.error || 'æœªçŸ¥é”™è¯¯'}`);
      }
    } catch (error: any) {
      console.error('âŒ ä¿¡å·ä¿¡æ¯åŠ è½½å¤±è´¥:', error);
      setSignalInfo({
        sysmode: 'NR',
        rsrp: -85,
        rsrq: -12,
        sinr: 15,
        loading: false,
        error: `ä¿¡å·ä¿¡æ¯è·å–å¤±è´¥: ${error.message}`
      });
    }
  }, [checkDeviceConnection, sendCommand]);

  // åŠ è½½ç½‘ç»œä¿¡æ¯ï¼ˆ5G NR CCçŠ¶æ€å’Œå½“å‰å°åŒºï¼‰- ä½¿ç”¨æ­£ç¡®çš„ATå‘½ä»¤
  const loadNetworkInfo = useCallback(async () => {
    setNetworkInfo(prev => ({ ...prev, loading: true, error: undefined }));
    
    try {
      console.log('ğŸŒ åŠ è½½ç½‘ç»œä¿¡æ¯...');
      
      // é¦–å…ˆæ£€æŸ¥è®¾å¤‡è¿æ¥
      const isConnected = await checkDeviceConnection();
      if (!isConnected) {
        throw new Error('è®¾å¤‡æœªè¿æ¥ï¼Œæ— æ³•è·å–ç½‘ç»œä¿¡æ¯');
      }
      
      // è·å–5G NR CCçŠ¶æ€ - ä½¿ç”¨AT^HFREQINFO?å‘½ä»¤
      const ccResponse = await sendCommand('AT^HFREQINFO?');
      console.log('ğŸ“‹ 5G NR CCå‘½ä»¤å“åº”:', ccResponse);
      
      let ccStatus: '1CC' | '2CC' = '1CC';
      let nrCount = 0;
      
      if (ccResponse.success && ccResponse.data?.response) {
        const hfreqResponse = ccResponse.data.response;
        console.log('ğŸŒ HFREQINFOåŸå§‹å“åº”:', hfreqResponse);
        
        // è§£æHFREQINFOå“åº”
        if (hfreqResponse.includes('^HFREQINFO:')) {
          const responseData = hfreqResponse.split('^HFREQINFO:')[1].split('\r\nOK')[0];
          const records = responseData.split(',');
          
          if (records.length >= 2) {
            const proa = parseInt(records[0]);
            const sysmode = parseInt(records[1]);
            
            // è®¡ç®—NRè½½æ³¢æ•°é‡
            if (sysmode === 7) { // NRæ¨¡å¼
              const remainingRecords = records.slice(2);
              nrCount = Math.floor(remainingRecords.length / 7); // æ¯ä¸ªNRè®°å½•æœ‰7ä¸ªå­—æ®µ
              ccStatus = nrCount >= 2 ? '2CC' : '1CC';
            }
          }
        }
      }
      
      // è·å–å½“å‰å°åŒºä¿¡æ¯ - ä½¿ç”¨AT+COPS?å‘½ä»¤
      const cellResponse = await sendCommand('AT+COPS?');
      console.log('ğŸ“‹ å°åŒºä¿¡æ¯å‘½ä»¤å“åº”:', cellResponse);
      
      let currentCell = {
        cellId: 'æœªçŸ¥',
        pci: 0,
        earfcn: 0,
        band: 'æœªçŸ¥'
      };
      
      if (cellResponse.success && cellResponse.data?.response) {
        // è¿™é‡Œå¯ä»¥è§£æCOPSå“åº”è·å–å°åŒºä¿¡æ¯
        // æš‚æ—¶ä½¿ç”¨ç¤ºä¾‹æ•°æ®
        currentCell = {
          cellId: '12345',
          pci: 579,
          earfcn: 627264,
          band: 'n78'
        };
      }
      
      console.log('âœ… è§£æçš„ç½‘ç»œä¿¡æ¯:', { ccStatus, nrCount, currentCell });
      
      setNetworkInfo({
        ccStatus,
        currentCell,
        loading: false
      });
      
    } catch (error: any) {
      console.error('âŒ ç½‘ç»œä¿¡æ¯åŠ è½½å¤±è´¥:', error);
      setNetworkInfo({
        ccStatus: '1CC',
        currentCell: {
          cellId: '12345',
          pci: 579,
          earfcn: 627264,
          band: 'n78'
        },
        loading: false,
        error: `ç½‘ç»œä¿¡æ¯è·å–å¤±è´¥: ${error.message}`
      });
    }
  }, [checkDeviceConnection, sendCommand]);

  // åŠ è½½ç½‘ç»œè¿é€šæ€§ä¿¡æ¯ - ä½¿ç”¨åç«¯ping API
  const loadConnectivityInfo = useCallback(async () => {
    setConnectivityInfo(prev => ({ ...prev, loading: true, error: undefined }));
    
    try {
      console.log('ğŸŒ æ£€æµ‹ç½‘ç»œè¿é€šæ€§...');
      
      // ä½¿ç”¨åç«¯ping APIæ£€æµ‹é˜¿é‡ŒDNS
      const response = await fetch('/api/network/ping', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ 
          host: '223.5.5.5', // é˜¿é‡ŒDNS
          count: 4,
          timeout: 5
        })
      });
      
      const data = await response.json();
      console.log('ğŸ“‹ Ping APIå“åº”:', data);
      
      if (data.success && data.data) {
        const pingResult = data.data;
        
        setConnectivityInfo({
          pingStatus: pingResult.success ? 'success' : 'failed',
          latency: Math.round(pingResult.avgTime || 0),
          packetLoss: Math.round(pingResult.packetLoss || 0),
          deviceConnected: true,
          loading: false
        });
        
        console.log('âœ… ç½‘ç»œè¿é€šæ€§æ£€æµ‹å®Œæˆ:', {
          status: pingResult.success ? 'success' : 'failed',
          latency: pingResult.avgTime,
          packetLoss: pingResult.packetLoss
        });
        
      } else {
        throw new Error(data.error || 'Ping APIè°ƒç”¨å¤±è´¥');
      }
      
    } catch (error: any) {
      console.error('âŒ ç½‘ç»œè¿é€šæ€§æ£€æµ‹å¤±è´¥:', error);
      
      // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ£€æµ‹æ–¹æ³•
      try {
        console.log('ğŸ”„ å°è¯•å¤‡ç”¨ç½‘ç»œçŠ¶æ€æ£€æŸ¥...');
        
        const statusResponse = await fetch('/api/network/status', {
          method: 'GET',
          credentials: 'include'
        });
        
        const statusData = await statusResponse.json();
        console.log('ğŸ“‹ ç½‘ç»œçŠ¶æ€æ£€æŸ¥å“åº”:', statusData);
        
        if (statusData.success && statusData.data) {
          const isConnected = statusData.data.overall === 'ok';
          const connectivity = statusData.data.connectivity || 0;
          
          setConnectivityInfo({
            pingStatus: isConnected ? 'success' : 'failed',
            latency: isConnected ? 30 : 0, // ä¼°ç®—å»¶è¿Ÿ
            packetLoss: Math.round((1 - connectivity) * 100),
            deviceConnected: true,
            loading: false,
            error: isConnected ? undefined : 'éƒ¨åˆ†ç½‘ç»œæ£€æŸ¥å¤±è´¥'
          });
        } else {
          throw new Error('ç½‘ç»œçŠ¶æ€æ£€æŸ¥ä¹Ÿå¤±è´¥äº†');
        }
        
      } catch (backupError) {
        console.error('âŒ å¤‡ç”¨ç½‘ç»œæ£€æµ‹ä¹Ÿå¤±è´¥:', backupError);
        
        // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        setConnectivityInfo({
          pingStatus: 'failed',
          latency: 0,
          packetLoss: 100,
          deviceConnected: false,
          loading: false,
          error: `ç½‘ç»œè¿é€šæ€§æ£€æµ‹å¤±è´¥: ${error.message}`
        });
      }
    }
  }, []);

  // åŠ è½½æ‰€æœ‰æ•°æ® - é¡ºåºå¼‚æ­¥è°ƒç”¨
  const loadAllData = useCallback(async () => {
    console.log('ğŸ”„ å¼€å§‹åŠ è½½ç³»ç»Ÿæ¦‚è§ˆæ•°æ®...');
    setGlobalLoading(true);
    
    try {
      // 1. åŠ è½½è®¾å¤‡åŸºæœ¬ä¿¡æ¯
      setLoadingProgress({ current: 1, total: 5, message: 'æ­£åœ¨è·å–è®¾å¤‡åŸºæœ¬ä¿¡æ¯...' });
      console.log('ğŸ“± 1/5 åŠ è½½è®¾å¤‡åŸºæœ¬ä¿¡æ¯...');
      await loadDeviceInfo();
      
      // æ·»åŠ å»¶è¿Ÿé¿å…APIå†²çª
      await new Promise(resolve => setTimeout(resolve, 800));
      
      // 2. åŠ è½½æ¸©åº¦ä¿¡æ¯
      setLoadingProgress({ current: 2, total: 5, message: 'æ­£åœ¨è·å–èŠ¯ç‰‡æ¸©åº¦...' });
      console.log('ğŸŒ¡ï¸ 2/5 åŠ è½½æ¸©åº¦ä¿¡æ¯...');
      await loadTemperatureInfo();
      
      await new Promise(resolve => setTimeout(resolve, 800));
      
      // 3. åŠ è½½ä¿¡å·ä¿¡æ¯
      setLoadingProgress({ current: 3, total: 5, message: 'æ­£åœ¨è·å–ä¿¡å·å¼ºåº¦...' });
      console.log('ğŸ“¶ 3/5 åŠ è½½ä¿¡å·ä¿¡æ¯...');
      await loadSignalInfo();
      
      await new Promise(resolve => setTimeout(resolve, 800));
      
      // 4. åŠ è½½ç½‘ç»œä¿¡æ¯
      setLoadingProgress({ current: 4, total: 5, message: 'æ­£åœ¨è·å–ç½‘ç»œçŠ¶æ€...' });
      console.log('ğŸŒ 4/5 åŠ è½½ç½‘ç»œä¿¡æ¯...');
      await loadNetworkInfo();
      
      await new Promise(resolve => setTimeout(resolve, 800));
      
      // 5. åŠ è½½è¿é€šæ€§ä¿¡æ¯
      setLoadingProgress({ current: 5, total: 5, message: 'æ­£åœ¨æ£€æµ‹ç½‘ç»œè¿é€šæ€§...' });
      console.log('ğŸŒ 5/5 åŠ è½½è¿é€šæ€§ä¿¡æ¯...');
      await loadConnectivityInfo();
      
      setLastUpdate(new Date().toLocaleTimeString());
      setLoadingProgress({ current: 5, total: 5, message: 'æ•°æ®åŠ è½½å®Œæˆ' });
      console.log('âœ… ç³»ç»Ÿæ¦‚è§ˆæ•°æ®åŠ è½½å®Œæˆ');
      
    } catch (error) {
      console.error('âŒ æ•°æ®åŠ è½½è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
      setLastUpdate(new Date().toLocaleTimeString() + ' (éƒ¨åˆ†å¤±è´¥)');
      setLoadingProgress({ current: 0, total: 5, message: 'æ•°æ®åŠ è½½å¤±è´¥' });
    } finally {
      setGlobalLoading(false);
      // æ¸…é™¤è¿›åº¦æ˜¾ç¤º
      setTimeout(() => {
        setLoadingProgress({ current: 0, total: 5, message: '' });
      }, 2000);
    }
  }, [loadDeviceInfo, loadTemperatureInfo, loadSignalInfo, loadNetworkInfo, loadConnectivityInfo]);

  // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
  const toggleAutoRefresh = useCallback(() => {
    if (autoRefresh) {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        setRefreshInterval(null);
      }
      setAutoRefresh(false);
      console.log('â¹ï¸ è‡ªåŠ¨åˆ·æ–°å·²å…³é—­');
    } else {
      const interval = setInterval(loadAllData, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
      setRefreshInterval(interval);
      setAutoRefresh(true);
      console.log('â–¶ï¸ è‡ªåŠ¨åˆ·æ–°å·²å¼€å¯');
    }
  }, [autoRefresh, refreshInterval, loadAllData]);

  // æµ‹è¯•ATIè§£æé€»è¾‘
  const testATIParsing = () => {
    const testATIResponse = `ATI

Manufacturer: TD Tech Ltd.
Model: MT5700M-CN
Revision: V200R001C20B014
IMEI: 864640060021043
+GCAP: +CGSM,+DS,+ES

OK`;
    
    console.log('ğŸ§ª æµ‹è¯•ATIè§£æé€»è¾‘');
    console.log('åŸå§‹å“åº”:', testATIResponse);
    
    // è§£æåˆ¶é€ å•†
    const manufacturerMatch = testATIResponse.match(/Manufacturer:\s*(.+)/i);
    const manufacturer = manufacturerMatch ? manufacturerMatch[1].trim() : null;
    
    // è§£æå‹å·
    const modelMatch = testATIResponse.match(/Model:\s*(.+)/i);
    const model = modelMatch ? modelMatch[1].trim() : null;
    
    // è§£æå›ºä»¶ç‰ˆæœ¬
    const revisionMatch = testATIResponse.match(/Revision:\s*(.+)/i);
    const revision = revisionMatch ? revisionMatch[1].trim() : null;
    
    // è§£æIMEI
    const imeiMatch = testATIResponse.match(/IMEI:\s*(\d+)/i);
    const imei = imeiMatch ? imeiMatch[1].trim() : null;
    
    console.log('è§£æç»“æœ:', {
      manufacturer,
      model,
      revision,
      imei
    });
  };

  // ç»„ä»¶æŒ‚è½½æ—¶åŠ è½½æ•°æ®
  useEffect(() => {
    // åœ¨å¼€å‘ç¯å¢ƒä¸‹æµ‹è¯•è§£æé€»è¾‘
    testATIParsing();
    
    loadAllData();
    
    // ç»„ä»¶å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
    return () => {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    };
  }, [loadAllData]);

  // è·å–æ¸©åº¦çŠ¶æ€é¢œè‰²
  const getTemperatureColor = (status?: string) => {
    switch (status) {
      case 'critical': return 'text-red-600';
      case 'warning': return 'text-yellow-600';
      default: return 'text-green-600';
    }
  };

  // è·å–ä¿¡å·å¼ºåº¦çŠ¶æ€
  const getSignalQuality = (rsrp?: number) => {
    if (!rsrp) return { color: 'text-gray-500', text: 'æœªçŸ¥' };
    if (rsrp >= -80) return { color: 'text-green-500', text: 'ä¼˜ç§€' };
    if (rsrp >= -90) return { color: 'text-blue-500', text: 'è‰¯å¥½' };
    if (rsrp >= -100) return { color: 'text-yellow-500', text: 'ä¸€èˆ¬' };
    return { color: 'text-red-500', text: 'è¾ƒå·®' };
  };

  // è·å–ç½‘ç»œåˆ¶å¼æ˜¾ç¤ºåç§°
  const getNetworkTypeName = (sysmode?: string) => {
    const types: { [key: string]: string } = {
      'NR': '5G NR',
      'LTE': '4G LTE',
      'WCDMA': '3G WCDMA',
      'GSM': '2G GSM'
    };
    return types[sysmode || ''] || sysmode || 'æœªçŸ¥';
  };

  return (
    <div className="space-y-6">
      {/* é¡µé¢å¤´éƒ¨ */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 dark:text-white">ç³»ç»Ÿæ¦‚è§ˆ</h1>
          <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">
            è®¾å¤‡çŠ¶æ€æ€»è§ˆ {lastUpdate && `â€¢ æœ€åæ›´æ–°: ${lastUpdate}`}
          </p>
        </div>
        <div className="flex space-x-3">
          <button
            onClick={toggleAutoRefresh}
            className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
              autoRefresh
                ? 'bg-green-100 text-green-700 hover:bg-green-200'
                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >
            {autoRefresh ? 'â¹ï¸ åœæ­¢è‡ªåŠ¨åˆ·æ–°' : 'â–¶ï¸ å¼€å¯è‡ªåŠ¨åˆ·æ–°'}
          </button>
          <button
            onClick={loadAllData}
            disabled={globalLoading}
            className={`px-4 py-2 rounded-lg transition-colors ${
              globalLoading 
                ? 'bg-gray-400 text-white cursor-not-allowed'
                : 'bg-blue-600 text-white hover:bg-blue-700'
            }`}
          >
            {globalLoading ? 'ğŸ”„ åˆ·æ–°ä¸­...' : 'ğŸ”„ æ‰‹åŠ¨åˆ·æ–°'}
          </button>
        </div>
      </div>

      {/* è®¾å¤‡è¿æ¥çŠ¶æ€æ£€æŸ¥ */}
      {(deviceInfo.error || temperatureInfo.error || signalInfo.error) && (
        <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
          <div className="flex items-center">
            <span className="text-yellow-400 mr-2">âš ï¸</span>
            <div>
              <h3 className="text-sm font-medium text-yellow-800 dark:text-yellow-400">
                è®¾å¤‡è¿æ¥é—®é¢˜
              </h3>
              <p className="text-sm text-yellow-700 dark:text-yellow-400 mt-1">
                éƒ¨åˆ†ATå‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š
              </p>
              <ul className="text-sm text-yellow-700 dark:text-yellow-400 mt-2 ml-4 list-disc">
                <li>è®¾å¤‡æ˜¯å¦æ­£ç¡®è¿æ¥åˆ°ç³»ç»Ÿ</li>
                <li>ATå‘½ä»¤æ¥å£æ˜¯å¦æ­£å¸¸å·¥ä½œ</li>
                <li>è®¾å¤‡æ˜¯å¦å¤„äºå¯é€šä¿¡çŠ¶æ€</li>
              </ul>
              <button
                onClick={loadAllData}
                disabled={globalLoading}
                className="mt-3 px-3 py-1 bg-yellow-600 text-white rounded text-sm hover:bg-yellow-700 disabled:bg-gray-400"
              >
                {globalLoading ? 'é‡è¯•ä¸­...' : 'ğŸ”„ é‡è¯•è¿æ¥'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* åŠ è½½è¿›åº¦æ˜¾ç¤º */}
      {globalLoading && (
        <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm font-medium text-blue-700 dark:text-blue-400">
              {loadingProgress.message}
            </span>
            <span className="text-sm text-blue-600 dark:text-blue-400">
              {loadingProgress.current}/{loadingProgress.total}
            </span>
          </div>
          <div className="w-full bg-blue-200 dark:bg-blue-800 rounded-full h-2">
            <div 
              className="bg-blue-600 h-2 rounded-full transition-all duration-500 ease-out"
              style={{ width: `${(loadingProgress.current / loadingProgress.total) * 100}%` }}
            ></div>
          </div>
          <div className="mt-2 text-xs text-blue-600 dark:text-blue-400">
            æ­£åœ¨é¡ºåºè°ƒç”¨APIï¼Œé¿å…è®¾å¤‡å‘½ä»¤å†²çª...
          </div>
        </div>
      )}
      {/* åŸºç¡€ä¿¡æ¯å¡ç‰‡ */}
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <h2 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
          <span className="text-2xl mr-2">ğŸ“±</span>
          åŸºç¡€ä¿¡æ¯
        </h2>
        
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div className="space-y-1">
            <p className="text-sm text-gray-600 dark:text-gray-400">è®¾å¤‡åˆ¶é€ å•†</p>
            <p className="font-medium text-gray-900 dark:text-white">
              {deviceInfo.loading ? (
                <span className="animate-pulse bg-gray-200 dark:bg-gray-700 h-4 w-16 rounded"></span>
              ) : (
                deviceInfo.manufacturer
              )}
            </p>
          </div>
          
          <div className="space-y-1">
            <p className="text-sm text-gray-600 dark:text-gray-400">è®¾å¤‡å‹å·</p>
            <p className="font-medium text-gray-900 dark:text-white">
              {deviceInfo.loading ? (
                <span className="animate-pulse bg-gray-200 dark:bg-gray-700 h-4 w-20 rounded"></span>
              ) : (
                deviceInfo.model
              )}
            </p>
          </div>
          
          <div className="space-y-1">
            <p className="text-sm text-gray-600 dark:text-gray-400">å›ºä»¶ç‰ˆæœ¬</p>
            <p className="font-medium text-gray-900 dark:text-white text-sm">
              {deviceInfo.loading ? (
                <span className="animate-pulse bg-gray-200 dark:bg-gray-700 h-4 w-32 rounded"></span>
              ) : (
                deviceInfo.revision
              )}
            </p>
          </div>
          
          <div className="space-y-1">
            <p className="text-sm text-gray-600 dark:text-gray-400">IMEI</p>
            <p className="font-medium text-gray-900 dark:text-white font-mono text-sm">
              {deviceInfo.loading ? (
                <span className="animate-pulse bg-gray-200 dark:bg-gray-700 h-4 w-28 rounded"></span>
              ) : (
                deviceInfo.imei
              )}
            </p>
          </div>
        </div>
        
        {deviceInfo.error && (
          <div className="mt-3 text-sm text-red-600 dark:text-red-400">
            âš ï¸ {deviceInfo.error}
          </div>
        )}
      </div>

      {/* çŠ¶æ€ä¿¡æ¯å¡ç‰‡ç½‘æ ¼ */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {/* èŠ¯ç‰‡æ¸©åº¦ */}
        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-sm font-medium text-gray-600 dark:text-gray-400">èŠ¯ç‰‡æ¸©åº¦</h3>
            <span className="text-2xl">ğŸŒ¡ï¸</span>
          </div>
          
          {temperatureInfo.loading ? (
            <div className="space-y-2">
              <div className="animate-pulse bg-gray-200 dark:bg-gray-700 h-8 w-16 rounded"></div>
              <div className="animate-pulse bg-gray-200 dark:bg-gray-700 h-4 w-12 rounded"></div>
            </div>
          ) : (
            <div>
              <div className={`text-2xl font-bold ${getTemperatureColor(temperatureInfo.status)}`}>
                {temperatureInfo.temperature}Â°C
              </div>
              <div className={`text-sm ${getTemperatureColor(temperatureInfo.status)}`}>
                {temperatureInfo.status === 'critical' ? 'è¿‡çƒ­' : 
                 temperatureInfo.status === 'warning' ? 'åé«˜' : 'æ­£å¸¸'}
              </div>
            </div>
          )}
          
          {temperatureInfo.error && (
            <div className="mt-2 text-xs text-red-600 dark:text-red-400">
              {temperatureInfo.error}
            </div>
          )}
        </div>

        {/* ä¿¡å·å¼ºåº¦è¯¦ç»†ä¿¡æ¯ */}
        <div className="signal-meter">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-sm font-medium text-gray-600 dark:text-gray-400">ä¿¡å·å¼ºåº¦</h3>
            <span className="text-2xl">ğŸ“¶</span>
          </div>
          
          {signalInfo.loading ? (
            <div className="space-y-2">
              <div className="animate-pulse bg-gray-200 dark:bg-gray-700 h-6 w-20 rounded"></div>
              <div className="animate-pulse bg-gray-200 dark:bg-gray-700 h-4 w-16 rounded"></div>
            </div>
          ) : (
            <div className="space-y-2">
              <div className={`text-lg font-bold ${getSignalQuality(signalInfo.rsrp).color}`}>
                RSRP: {signalInfo.rsrp} dBm
              </div>
              <div className="text-sm text-gray-600 dark:text-gray-400">
                RSRQ: {signalInfo.rsrq} dB
              </div>
              <div className="text-sm text-gray-600 dark:text-gray-400">
                SINR: {signalInfo.sinr} dB
              </div>
              <div className={`text-xs ${getSignalQuality(signalInfo.rsrp).color}`}>
                {getSignalQuality(signalInfo.rsrp).text}
              </div>
            </div>
          )}
          
          {signalInfo.error && (
            <div className="mt-2 text-xs text-red-600 dark:text-red-400">
              {signalInfo.error}
            </div>
          )}
        </div>

        {/* 5G NR CCçŠ¶æ€ */}
        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-sm font-medium text-gray-600 dark:text-gray-400">5G NR CCçŠ¶æ€</h3>
            <span className="text-2xl">ğŸŒ</span>
          </div>
          
          {networkInfo.loading ? (
            <div className="space-y-2">
              <div className="animate-pulse bg-gray-200 dark:bg-gray-700 h-8 w-12 rounded"></div>
              <div className="animate-pulse bg-gray-200 dark:bg-gray-700 h-4 w-20 rounded"></div>
            </div>
          ) : (
            <div>
              <div className={`text-2xl font-bold ${
                networkInfo.ccStatus === '2CC' ? 'text-green-600' : 'text-blue-600'
              }`}>
                {networkInfo.ccStatus}
              </div>
              <div className="text-sm text-gray-600 dark:text-gray-400">
                {networkInfo.ccStatus === '2CC' ? 'è½½æ³¢èšåˆ' : 'å•è½½æ³¢'}
              </div>
              <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                {getNetworkTypeName(signalInfo.sysmode)}
              </div>
            </div>
          )}
          
          {networkInfo.error && (
            <div className="mt-2 text-xs text-red-600 dark:text-red-400">
              {networkInfo.error}
            </div>
          )}
        </div>

        {/* ç½‘ç»œè¿é€šçŠ¶æ€ */}
        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-sm font-medium text-gray-600 dark:text-gray-400">ç½‘ç»œè¿é€š</h3>
            <span className="text-2xl">ğŸŒ</span>
          </div>
          
          {connectivityInfo.loading ? (
            <div className="space-y-2">
              <div className="animate-pulse bg-gray-200 dark:bg-gray-700 h-8 w-16 rounded"></div>
              <div className="animate-pulse bg-gray-200 dark:bg-gray-700 h-4 w-20 rounded"></div>
            </div>
          ) : (
            <div>
              <div className={`text-lg font-bold ${
                connectivityInfo.pingStatus === 'success' ? 'text-green-600' : 
                connectivityInfo.pingStatus === 'timeout' ? 'text-yellow-600' : 'text-red-600'
              }`}>
                {connectivityInfo.pingStatus === 'success' ? 'âœ… è¿é€šæ­£å¸¸' : 
                 connectivityInfo.pingStatus === 'timeout' ? 'â±ï¸ è¿æ¥è¶…æ—¶' : 'âŒ è¿æ¥å¤±è´¥'}
              </div>
              
              {connectivityInfo.pingStatus === 'success' && (
                <>
                  <div className="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    å»¶è¿Ÿ: {connectivityInfo.latency}ms
                  </div>
                  <div className="text-xs text-gray-500 dark:text-gray-400">
                    ä¸¢åŒ…ç‡: {connectivityInfo.packetLoss}%
                  </div>
                </>
              )}
              
              {connectivityInfo.deviceConnected !== undefined && (
                <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                  è®¾å¤‡: {connectivityInfo.deviceConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}
                </div>
              )}
            </div>
          )}
          
          {connectivityInfo.error && (
            <div className="mt-2 text-xs text-orange-600 dark:text-orange-400 bg-orange-50 dark:bg-orange-900/20 p-2 rounded">
              â„¹ï¸ {connectivityInfo.error}
            </div>
          )}
        </div>
      </div>

      {/* å½“å‰å°åŒºçŠ¶æ€ */}
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <h2 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
          <span className="text-2xl mr-2">ğŸ—¼</span>
          å½“å‰å°åŒºçŠ¶æ€
        </h2>
        
        {networkInfo.loading ? (
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            {[1, 2, 3, 4].map(i => (
              <div key={i} className="space-y-2">
                <div className="animate-pulse bg-gray-200 dark:bg-gray-700 h-4 w-16 rounded"></div>
                <div className="animate-pulse bg-gray-200 dark:bg-gray-700 h-6 w-20 rounded"></div>
              </div>
            ))}
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div className="space-y-1">
              <p className="text-sm text-gray-600 dark:text-gray-400">å°åŒºID</p>
              <p className="font-medium text-gray-900 dark:text-white">
                {networkInfo.currentCell?.cellId || 'æœªçŸ¥'}
              </p>
            </div>
            
            <div className="space-y-1">
              <p className="text-sm text-gray-600 dark:text-gray-400">PCI</p>
              <p className="font-medium text-gray-900 dark:text-white">
                {networkInfo.currentCell?.pci || 'æœªçŸ¥'}
              </p>
            </div>
            
            <div className="space-y-1">
              <p className="text-sm text-gray-600 dark:text-gray-400">é¢‘ç‚¹</p>
              <p className="font-medium text-gray-900 dark:text-white">
                {networkInfo.currentCell?.earfcn || 'æœªçŸ¥'}
              </p>
            </div>
            
            <div className="space-y-1">
              <p className="text-sm text-gray-600 dark:text-gray-400">é¢‘æ®µ</p>
              <p className="font-medium text-gray-900 dark:text-white">
                {networkInfo.currentCell?.band || 'æœªçŸ¥'}
              </p>
            </div>
          </div>
        )}
        
        {networkInfo.error && (
          <div className="mt-3 text-sm text-red-600 dark:text-red-400">
            âš ï¸ {networkInfo.error}
          </div>
        )}
      </div>

      {/* å®æ—¶ç›‘æ§å›¾è¡¨åŒºåŸŸ */}
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <h2 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
          <span className="text-2xl mr-2">ğŸ“ˆ</span>
          å®æ—¶ç›‘æ§
        </h2>
        
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* ä¿¡å·å¼ºåº¦è¶‹åŠ¿ */}
          <div className="text-center">
            <h3 className="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">ä¿¡å·å¼ºåº¦è¶‹åŠ¿</h3>
            <div className="h-32 bg-gray-50 dark:bg-gray-700 rounded-lg flex items-center justify-center">
              <span className="text-gray-500 dark:text-gray-400 text-sm">å›¾è¡¨åŒºåŸŸ</span>
            </div>
          </div>
          
          {/* æ¸©åº¦å˜åŒ– */}
          <div className="text-center">
            <h3 className="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">æ¸©åº¦å˜åŒ–</h3>
            <div className="h-32 bg-gray-50 dark:bg-gray-700 rounded-lg flex items-center justify-center">
              <span className="text-gray-500 dark:text-gray-400 text-sm">å›¾è¡¨åŒºåŸŸ</span>
            </div>
          </div>
          
          {/* ç½‘ç»œå»¶è¿Ÿ */}
          <div className="text-center">
            <h3 className="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">ç½‘ç»œå»¶è¿Ÿ</h3>
            <div className="h-32 bg-gray-50 dark:bg-gray-700 rounded-lg flex items-center justify-center">
              <span className="text-gray-500 dark:text-gray-400 text-sm">å›¾è¡¨åŒºåŸŸ</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
